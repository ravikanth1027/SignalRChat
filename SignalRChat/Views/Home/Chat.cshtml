@{
    ViewBag.Title = "Chat";
}
<h2>Chat</h2>
<div class="container">
    @*<input type="text" id="message" />
        <input type="button" id="sendmessage" value="Send" />*@
    <input type="hidden" id="displayname" />
    <input type="hidden" id="displayID" />
    <ul id="discussion"></ul>
</div>

<div id="chat_widnow">
    <div id="chat_title_bar">
        <span class="col-sm-9 text-primary"><strong>Users</strong></span>
        <div id="chat_min_button"><i class="fa fa-plus-square"></i></div>
    </div>
    <div id="chat_box" style="display: none;overflow-y:auto;">
    </div>
</div>

<div class="modal fade" id="myModal" role="dialog">
    <div class="modal-dialog">

        <!-- Modal content-->
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h4 class="modal-title">Create Group</h4>
            </div>
            <div class="modal-body text-center">

                <div>
                    <input type="text" id="group_id" />
                </div>
                <div class="form-group">
                    <select class="custom-select" id="select_users" multiple="multiple">

                        <option value="1">Ravi</option>
                        <option value="2">Nikhil</option>
                        <option value="3">Rupesh Kumar</option>
                        <option value="4">Avinash</option>
                        <option value="5">Satya</option>
                        <option value="6">Pavan</option>
                        <option value="7">Raja</option>
                    </select>

                </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="create_group_btn" class="btn btn-default" data-dismiss="modal" onclick="addGroup()">Create</button>
            </div>
        </div>

    </div>
</div>

<div style="width: 55%; border: solid 1px Red; height: 40px ; display: none">
    <h3 style="margin: 10px 0px 0px 10px">
        <span id="spnName"></span>
        <span id="GroupName" style="margin-left: 25px;"></span>
    </h3>
</div>

<div id="chat_div"></div>
<input id="hdId" type="hidden" />
<input id="hdUserName" type="hidden" />
<asp:HiddenField ID="hdnCurrentUserName" runat="server" />
<asp:HiddenField ID="hdnCurrentUserID" runat="server" />
@section scripts {
    <!--Script references. -->
    <!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
    <!--Reference the SignalR library. -->
    <script src="~/Scripts/jquery.signalR-2.4.1.min.js"></script>
    <link rel="stylesheet" href="~/Scripts/font-awesome/css/fontawesome.min.css" type="text/css" />
    <link rel="stylesheet" href="~/Content/jquery.ui.chatbox.css" type="text/css" />
    <link rel="stylesheet" href="~/Scripts/jqueryui/jquery-ui.min.css" type="text/css" />
    <script src="~/Scripts/jqueryui/jquery-ui.js"></script>
    <script src="~/Scripts/jqueryui/jquery-ui.min.js"></script>
    <script src="~/Scripts/jquery.ui.chatbox.js"></script>
    <script>
        window.resolveUrl = function(url) {
            return "@Url.Content("~")" + url; // Handle slashes, nulls, etc...
        };
    </script>



    <!--Reference the autogenerated SignalR hub script. -->
    <script src="~/signalr/hubs"></script>
    <script>
        var srp = "@Url.Content("~")";
        $('#displayname').val(prompt('Enter your name:', ''));
        $('#displayID').val(prompt('Enter your ID:', ''));
        $('#hdnCurrentUserName').val($('#displayname').val());
        $('#hdnCurrentUserID').val($('#displayID').val());
    </script>

    <script src="~/Scripts/chatboxManager.js"></script>
    <script>
        function addGroup() {
            //var listofUser = [], suser;
            var _name = document.getElementById("hdUserName").value;
            var _group = document.getElementById('group_id').value;
            var listofUser = [];

            $("#select_users :selected").each(function () {
                console.log($(this).text().concat("-", $(this).val()))
                //listofUser.push($(this).text().concat("-", $(this).val()));
                listofUser.push($(this).val());
            });




            $("#spnName").text(_name);
            $("#GroupName").text(_group);
            $('#txtMsg').val('');
            //var listofUser = ["1", "2", "3"];
            chatHub.server.addgroupserver($("#spnName").text(), $("#connID").text(), $("#connID").text(), $("#GroupName").text(), listofUser);
        }
    </script>



    <!--SignalR script to update the chat page and send messages.-->
    @*<script>

            $(document).ready(function () {
                $('#displayname').val(prompt('Enter your name:', ''));
                $('#displayID').val(prompt('Enter your ID:', ''));
                $('#hdnCurrentUserName').val($('#displayname').val());
                $('#hdnCurrentUserID').val($('#displayID').val());
                $('<audio id="chatAudio"><source src="' + srp + 'images/notify.ogg" type="audio/ogg"><source src="' + srp + 'images/notify.mp3" type="audio/mpeg"><source src="' + srp + 'images/notify.wav" type="audio/wav"></audio>').appendTo('body');

                // Declare a proxy to reference the hub.
                var chatHub = $.connection.chatHub;
                registerClientMethods(chatHub);
                // Start Hub
                $.connection.hub.start().done(function () {
                    registerEvents(chatHub);
                    //registerEvents_group(chatProxy);
                });

                $("#chat_min_button").click(function () {
                    if ($(this).html() == "<i class=\"fa fa-minus-square\"></i>") {
                        $(this).html("<i class=\"fa fa-plus-square\"></i>");
                    }
                    else {
                        $(this).html("<i class=\"fa fa-minus-square\"></i>");
                    }
                    $("#chat_box").slideToggle();
                    //$("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal'>Create Group</button>");
                    //$("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal_new'>Join Group</button>");
                });
                $("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal'>Create Group</button>");
                setInterval(ResetTypingFlag, 6000);
            });



            function registerEvents(chatHub) {
                var UserName = $("[id$=hdnCurrentUserName]").val();
                var UserID = parseInt($("[id$=hdnCurrentUserID]").val());
                chatHub.server.connect(UserName, UserID);

                //chatProxy.server.connect($("#spnName").text(), $("#connID").text(), $("#connID").text());
            }



            function registerClientMethods(chatHub) {
                // Calls when user successfully logged in
                chatHub.client.onConnected = function (id, userName, allUsers, messages, userid) {
                    $('#hdId').val(id);
                    $('#hdUserName').val(userName);

                    // Add All Users
                    for (i = 0; i < allUsers.length; i++) {
                        //AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName, userid);
                        ////console.log("Adding User:" + allUsers[i].UserName)
                        AddUser(chatHub, allUsers[i].UserID, allUsers[i].UserName, userid);
                    }

                    // Add Existing Messages
                    for (i = 0; i < messages.length; i++) {
                        AddMessage(messages[i].UserName, messages[i].Message);
                    }

                }
            }

            // On New User Connected
            chatHub.client.onNewUserConnected = function (id, name, userid) {
                AddUser(chatHub, id, name, userid);
            }

            // On User Disconnected
            chatHub.client.onUserDisconnected = function (id, userName) {
                $('#' + id).remove();
            }

            chatHub.client.messageReceived = function (userName, message) {
                AddMessage(userName, message);
                //var code = "<p>" + message + "</p>";
                //$("#chat_box").append(code);
            }


            chatHub.client.sendPrivateMessage = function (windowId, fromUserName, chatTitle, message) {
                ////console.log("sendPrivateMessage" + windowId);
                var ctrId = 'private_' + windowId;
                if ($('#' + ctrId).length == 0) {
                    createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, chatTitle);
                    $('#chatAudio')[0].play();
                }
                else {
                    var rType = CheckHiddenWindow();
                    if ($('#' + ctrId).parent().css('display') == "none") {
                        $('#' + ctrId).parent().parent().effect("shake", { times: 2 }, 1000);
                        rType = true;
                    }
                    if (rType == true) {
                        $('#chatAudio')[0].play();
                    }
                }

                // To Be changed - Ravi
                //$('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                //
                $('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                $('#typing_' + windowId).hide();
            }
            // Ravi

            chatHub.client.sendGroupMessage = function (chatTitle, windowId, message, fromUserName) {
                //console.log("windowID" + windowId);
                //console.log("fromUsername" + fromUserName);
                //console.log("ChatTitle: " + chatTitle);
                console.log("mesasge: " + message);
                var ctrId = "group_" + windowId;
                //console.log("ctrID---------", $('#' + ctrId).length );
                if ($('#' + ctrId).length == 0) {
                    //console.log("I am here");
                    createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, chatTitle);
                    $('#chatAudio')[0].play();
                }
                else {
                    var rType = CheckHiddenWindow();
                    if ($('#' + ctrId).parent().css('display') == "none") {
                        $('#' + ctrId).parent().parent().effect("shake", { times: 2 }, 1000);
                        rType = true;
                    }
                    if (rType == true) {
                        $('#chatAudio')[0].play();
                    }
                }

                // To Be changed - Ravi
                //$('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                //
                $('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                $('#typing_' + windowId).hide();
            }


            // Testing



            chatHub.client.receiveMessage = function (msgFrom, msg, senderid) {

                if (msgFrom == "NewConnection") {
                    ////console.log("msg:", msg);
                    $("#usersCount").text(senderid);
                    $('#divUsers').append('<li>' + msg + '</li>')
                }
                else if (msgFrom == "ChatHub") {
                    ////console.log("msg:", msg);
                    $("#usersCount").text(senderid);
                    $("#connID").text(msg);
                }
                else if (msgFrom == "RU") {
                    ////console.log("msg:", msg);
                    var online = senderid.split('#');
                    var length = online.length;
                    for (var i = 0; i < length; i++) {
                        $('#divUsers').append('<li>' + online[i] + '</li>')
                    }

                    $('#divChat').append('<li><strong>' + msgFrom
                        + '</strong>:&nbsp;&nbsp;' + msg + '</li>')
                }
                else {
                    ////console.log("msg:", msg);
                    $("#txtTo").val(senderid);
                    $('#divChat').append('<li><strong>' + msgFrom
                        + '</strong>:&nbsp;&nbsp;' + msg + '</li>')
                }
            };

            chatHub.client.GetLastMessages = function (TouserID, CurrentChatMessages) {
                //debugger;
                var ctrId = 'private_' + TouserID;

                var AllmsgHtml = "";
                for (i = 0; i < CurrentChatMessages.length; i++) {
                    if (CurrentChatMessages[i].Message.includes("#")) {
                        var array = CurrentChatMessages[i].Message.split("#");
                        var fileName = array[1].split('\\');
                        var msg = '<a href="' + array[1] + '">' + fileName[fileName.length - 1] + '</a>';
                        CurrentChatMessages[i].Message = msg;


                    }

                    AllmsgHtml += "<div id='divChatWindow' style=\"display: block; max-width: 200px;\" class=\"ui-chatbox-msg\">";
                    if (i == CurrentChatMessages.length - 1) {
                        if ($('#' + ctrId).children().last().html() != "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>") {
                            AllmsgHtml += "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>";
                        }
                    }
                    else {
                        AllmsgHtml += "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>";
                    }
                    AllmsgHtml += "</div>";
                }
                $('#' + ctrId).prepend(AllmsgHtml);


            }


            chatHub.client.GetGroupLastMessages = function (TouserID, CurrentChatMessages) {
                //debugger;
                var TouserID = TouserID;
                //console.log("TouserID: " + TouserID);
                if (TouserID.includes("group_")) {
                    //console.log("in Get Messages - group");
                    var ctrId = TouserID;
                    ////console.log('Helo' + CurrentChatMessages[0].txt)
                    var AllmsgHtml = "";
                    for (i = 0; i < CurrentChatMessages.length; i++) {
                        if (CurrentChatMessages[i].txt.includes("#")) {
                            var array = CurrentChatMessages[i].txt.split("#");
                            var fileName = array[1].split('\\');
                            var msg = '<a href="' + array[1] + '">' + fileName[fileName.length - 1] + '</a>';
                            CurrentChatMessages[i].txt = msg;


                        }

                        AllmsgHtml += "<div id='divChatWindow' style=\"display: block; max-width: 200px;\" class=\"ui-chatbox-msg\">";
                        if (i == CurrentChatMessages.length - 1) {
                            if ($('#' + ctrId).children().last().html() != "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>") {
                                AllmsgHtml += "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>";
                            }
                        }
                        else {
                            AllmsgHtml += "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>";
                        }
                        AllmsgHtml += "</div>";
                    }
                    $('#' + ctrId).prepend(AllmsgHtml);
                }

            }
            chatHub.client.sampleMessage = function (toUser, fromUser, fromUserid, groupid, groupName, msg) {
                ////console.log(" groupName" + groupName + "groupid" + groupid);
                var sel = document.getElementById('join_groups');
                var opt = document.createElement('option');
                opt.appendChild(document.createTextNode(groupName));
                opt.value = groupName;
                sel.appendChild(opt);
                var connectionid = $('#hdId').val();
                code = $('<div id="' + groupName + '" class="col-sm-12 bg-success"  ><i class=\"fa fa-user\"></i> ' + groupName + '<div>');
                $("#chat_box").append(code);
                $(".mydiv").append(code);
                var id = groupid;
                //OpenPrivateChatWindow(chatHub, id, groupName);
                ////console.log(" hdUsername--------------------" + $('#hdUserName').val());
                //chatHub.server.broadCastMessage($('#hdUserName').val(), msg, groupName);
                $(code).dblclick(function () {
                    var id = $(this).attr('id');
                    ////console.log("samplemessghae:", id)
                    if (connectionid != id) {
                        ////console.log("groupid ---id"+id)
                        OpenPrivateChatWindow(chatHub, "group_" + id, groupName);
                    }
                });
            }



            function sendtoGroup(groupName) {
                chatHub.server.broadCastMessage($("#spnName").text(), $("#txtMsg").val(), groupName);
                $('#txtMsg').val('').focus();
            }
            function CheckHiddenWindow() {
                var hidden, state;

                if (typeof document.hidden !== "undefined") {
                    state = "visibilityState";
                } else if (typeof document.mozHidden !== "undefined") {
                    state = "mozVisibilityState";
                } else if (typeof document.msHidden !== "undefined") {
                    state = "msVisibilityState";
                } else if (typeof document.webkitHidden !== "undefined") {
                    state = "webkitVisibilityState";
                }

                if (document[state] == "hidden")
                    return true;
                else
                    return false;

            }

            function AddUser(chatHub, id, name, userid) {
                var currentuserid = parseInt($("[id$=hdnCurrentUserID]").val());
                console.log("currentuserid:" + currentuserid);
                var connectionid = $('#hdId').val();
                console.log("connectionid:" + connectionid);
                var code = "";
                if (connectionid == "") {
                    if (userid == currentuserid) {
                        $('#hdId').val(id);
                        connectionid = id;
                        $('#hdUserName').val(name);
                    }
                }
                if (connectionid != id) {
                    if ($('#' + id).length == 0) {
                        code = $('<a id="' + id + '" class="col-sm-12 bg-success" > <i class=\"fa fa-user\"></i> ' + name + '<a>');
                        $(code).dblclick(function () {
                            var id = $(this).attr('id');
                            if (connectionid != id) {
                                OpenPrivateChatWindow(chatHub, id, name);
                            }
                        });
                    }
                }
                else {
                    if ($('#curruser_' + id).length == 0) {
                        code = $('<div id="curruser_' + id + '" class="col-sm-12 bg-info"  ><i class=\"fa fa-user\"></i> ' + name + '<div>');

                    }
                }

                //file_image = $('<div><button type="button">Click Me!</button><div>');
                $("#chat_box").append(code);


                //$("#chat_box").append(file_image);
            }


            function AddUsertoGroup(chatHub, id, name, userid) {
                var currentuserid = parseInt($("[id$=hdnCurrentUserID]").val());
                ////console.log("currentuserid:" + currentuserid);
                var connectionid = $('#hdId').val();
                ////console.log("connectionid:" + connectionid);
                var code = "";
                if (connectionid == "") {
                    if (userid == currentuserid) {
                        $('#hdId').val(id);
                        connectionid = id;
                        $('#hdUserName').val(name);
                    }
                }


                if (connectionid != id) {
                    if ($('#' + id).length == 0) {
                        code = $('<a id="' + id + '" class="col-sm-12 bg-success" > <i class=\"fa fa-user\"></i> ' + name + '<a>');
                        $(code).dblclick(function () {
                            var id = $(this).attr('id');
                            if (connectionid != id) {
                                OpenPrivateChatWindow(chatHub, id, name);
                            }
                        });
                    }
                }
                else {
                    if ($('#curruser_' + id).length == 0) {
                        code = $('<div id="curruser_' + id + '" class="col-sm-12 bg-info"  ><i class=\"fa fa-user\"></i> ' + name + '<div>');

                    }
                }

                //file_image = $('<div><button type="button">Click Me!</button><div>');
                $("#chat_box").append(code);
                //$("#chat_box").append("<button id='btnSend' onclick='sendtoGroup()' >Send Message</button>");
                //$("#chat_box").append(file_image);
            }

            //function OpenPrivateChatWindow(chatHub, id, userName) {
            //    var ctrId = 'private_' + id;
            //    if ($('#' + ctrId).length > 0) return;
            //    createPrivateChatWindow(chatHub, id, ctrId, userName, userName);
            //}
            function OpenPrivateChatWindow(chatHub, id, userName) {
                var ctrId = "";
                //console.log("Username: " + userName + "  ID:"+ id)
                if (id.includes("group_")) {
                    ctrId = id
                    //////console.log("crtd group_:" + ctrId);
                } else {
                    ctrId = 'private_' + id;
                }

                if ($('#' + ctrId).length > 0) return;

                createPrivateChatWindow(chatHub, id, ctrId, userName, userName);

            }

            function createPrivateChatWindow(chatHub, userId, ctrId, userName, chatTitle) {
                ////console.log("ctrId:" + ctrId);
                $("#chat_div").append("<div id=\"" + ctrId + "\"></div>")
                showList.push(ctrId);

                $('#' + ctrId).chatbox({
                    id: ctrId,
                    title: chatTitle,
                    user: userName,
                    offset: getNextOffset(),
                    width: 200,
                    messageSent: function (id, user, msg) {
                        if (id.includes("group_")) {
                            var group_name = id.split("_");
                            chatHub.server.broadCastMessage($('#hdUserName').val(), msg, group_name[1])
                        } else {
                            chatHub.server.sendPrivateMessage(userId, msg);
                        }


                        //chatHub.server.sendmessagetoall(userId, msg);
                        TypingFlag = true;
                    },
                    boxClosed: function (removeid) {
                        $('#' + removeid).remove();
                        var idx = showList.indexOf(removeid);
                        if (idx != -1) {
                            showList.splice(idx, 1);
                            diff = config.width + config.gap;
                            for (var i = idx; i < showList.length; i++) {
                                offset = $("#" + showList[i]).chatbox("option", "offset");
                                $("#" + showList[i]).chatbox("option", "offset", offset - diff);
                            }
                        }
                    }

                });

                $('#' + ctrId).siblings().css("position", "relative");
                $('#' + ctrId).siblings().append("<div id=\"typing_" + userId + "\" style=\"width:20px; height:20px; display:none; position:absolute; right:14px; top:8px\"><img height=\"20\" src=\"" + srp + "images/pencil.gif\" /></div>");
                $('#' + ctrId).siblings().append("<input type='file' id='fileUpload_" + userId + "' /> ");
                console.log("Sending UserId", userId);
                $('#' + ctrId).siblings().append("<input type='button' id='btnUploadFile' value='Send' onclick='onUploadButton(" + userId + "," + ctrId + ")'/>");
                $('#' + ctrId).siblings().find('textarea').on('input', function (e) {
                    if (TypingFlag == true) {
                        chatHub.server.sendUserTypingRequest(userId);
                    }
                    TypingFlag = false;
                });

                var FromUserID = parseInt($("[id$=hdnCurrentUserID]").val());
                var ToUserID = userId;
                //console.log("For Last Messages:", ToUserID);
                if (ToUserID.includes("group_")) {
                    //console.log("Calling  RequestLastGroupMessage");
                    //var group_name = ToUserID.split("_");
                    chatHub.server.RequestLastGroupMessage(FromUserID, ToUserID);
                } else {
                    chatHub.server.requestLastMessage(FromUserID, ToUserID);
                }

            }

            chatHub.client.ReceiveTypingRequest = function (userId) {
                var ctrId = 'private_' + userId;
                if ($('#' + ctrId).length > 0) {
                    jQuery('#typing_' + userId).show();
                    jQuery('#typing_' + userId).delay(6000).fadeOut("slow");
                }
            }

            // list of boxes shown on the page
            var showList = new Array();
            var config = {
                width: 200, //px
                gap: 20,
                maxBoxes: 5
            };

            var getNextOffset = function () {
                return (config.width + config.gap) * showList.length;
            };

            var TypingFlag = true;

            function ResetTypingFlag() {
                TypingFlag = true;
            }

            function AddMessage(userName, message) {
                //////console.log("Called Addmesssge from group");
                //$('#divChatWindow').append('<div class="message"><span class="userName">' + userName + '</span>: ' + message + '</div>');
                //var height = $('#divChatWindow')[0].scrollHeight;
                //$('#divChatWindow').scrollTop(height);
            }

            function saveFile() {
                ////console.log("Clicked on save file");
                var firstName = $("#fileContainer").val();
                ////console.log(firstName.files[0])
                localStorage.setItem("file", firstName)
            }

            function showfileName(userId, ctrId) {
                var x = document.getElementById('fileContainer');
                ////console.log(x.files.length);
                if (x.files.length > 0) {
                    ////console.log("Inside length");
                    getBase64(x.files[0], userId);

                }


            }

            function onUploadButton(userId, ctrId) {
                console.log("onUpload Button:", userId);
                var data = new FormData();
                var filename_v;
                if (typeof userId.id === 'undefined') {
                    //flag = false;
                    var files = $("#fileUpload_" + userId).get(0).files;
                } else {
                    if (userId.id.includes("group_")) {
                        //flag = true
                        var files = $("#fileUpload_" + userId.id).get(0).files;
                    }
                }
                //var files = $("#fileUpload_" + userId).get(0).files;
                //$("#fileUpload").value = "";
                //$("#fileUpload").val('');



                // Add the uploaded image content to the form data collection
                console.log("Length of files", files.length)
                if (files.length > 0) {
                    data.append("UploadedImage", files[0]);
                    filename_v = files[0].filename;
                    console.log(files[0])
                }

                var flag = false;

                if (typeof userId.id === 'undefined') {
                    flag = false;
                } else {
                    if (userId.id.includes("group_")) {
                        flag = true
                    }
                }


                // Make Ajax request with the contentType = false, and procesDate = false
                if (flag) {
                    var group_name = userId.id.split("_");
                    var ajaxRequest = $.ajax({
                        type: "POST",
                        url: "/api/fileupload/uploadfile",
                        contentType: false,
                        processData: false,
                        data: data
                    });
                    ajaxRequest.done(function (xhr, textStatus) {
                        var f_tag = "#" + xhr.Value;
                        console.log("xhr.Value", f_tag)
                        chatHub.server.broadCastMessage($('#hdUserName').val(), f_tag, group_name[1]);
                    });
                    //$("#fileUpload").val('');
                } else {
                    var ajaxRequest = $.ajax({
                        type: "POST",
                        url: "/api/fileupload/uploadfile",
                        contentType: false,
                        processData: false,
                        data: data
                    });

                    ajaxRequest.done(function (xhr, textStatus) {
                        var f_tag = "#" + xhr.Value;
                        chatHub.server.sendPrivateMessage(userId, f_tag);

                    });
                    //$("#fileUpload").val('');
                }
                //
                //files = '';
            }

            function btnUpload() {
                ////console.log("Helloword")
                // Checking whether FormData is available in browser
                if (window.FormData !== undefined) {
                    ////console.log("Inside Ajax function")
                    var fileUpload = document.getElementById("FileUpload1").get(0);
                    var files = fileUpload.files;

                    // Create FormData object
                    var fileData = new FormData();

                    // Looping over all files and add it to FormData object
                    for (var i = 0; i < files.length; i++) {
                        fileData.append(files[i].name, files[i]);
                        //////console.log(files[i]);
                    }

                    // Adding one more key to FormData object
                    fileData.append('username', 'Manas');

                    $.ajax({
                        type: "POST",
                        url: 'StartChat.aspx/UploadFiles',
                        contentType: false, // Not to set any content header
                        processData: false, // Not to process data
                        data: fileData,
                        dataType: "json",
                        success: function (result) {
                            alert(result.d);

                        },
                        error: function (err) {
                            alert(err.statusText);
                        }
                    });
                } else {
                    alert("FormData is not supported.");
                }
            }

        </script>*@




















    @*<script>
            $(function () {
                var srp = "@Url.Content("~")";
                // Reference the auto-generated proxy for the hub.
                var chatHub = $.connection.chatHub;
                registerClientMethods(chatHub);
                // Start Hub
                $.connection.hub.start().done(function () {
                    registerEvents(chatHub);
                    //registerEvents_group(chatProxy);
                });
                //var chatHub = $.connection.chatHub;

                // Create a function that the hub can call back to display messages.
                chatHub.client.addNewMessageToPage = function (name, message) {
                    // Add the message to the page.
                    $('#discussion').append('<li><strong>' + htmlEncode(name)
                        + '</strong>: ' + htmlEncode(message) + '</li>');
                };
                // Get the user name and store it to prepend to messages.
                $('#displayname').val(prompt('Enter your name:', ''));
                $('#displayID').val(prompt('Enter your ID:', ''));
                $('#hdnCurrentUserName').val($('#displayname').val());
                $('#hdnCurrentUserID').val($('#displayID').val());
                // Set initial focus to message input box.
                $('#message').focus();


                $('<audio id="chatAudio"><source src="' + srp + 'images/notify.ogg" type="audio/ogg"><source src="' + srp + 'images/notify.mp3" type="audio/mpeg"><source src="' + srp + 'images/notify.wav" type="audio/wav"></audio>').appendTo('body');

                // Declare a proxy to reference the hub.
                //var chatHub = $.connection.chatHub;



                $("#chat_min_button").click(function () {
                    if ($(this).html() == "<i class=\"fa fa-minus-square\"></i>") {
                        $(this).html("<i class=\"fa fa-plus-square\"></i>");
                    }
                    else {
                        $(this).html("<i class=\"fa fa-minus-square\"></i>");
                    }
                    $("#chat_box").slideToggle();
                    //$("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal'>Create Group</button>");
                    //$("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal_new'>Join Group</button>");
                });
                $("#chat_box").append("<button type='button' class='btn btn-info btn-sm' data-toggle='modal' data-target='#myModal'>Create Group</button>");
                setInterval(ResetTypingFlag, 6000);

                // On New User Connected
                chatHub.client.onNewUserConnected = function (id, name, userid) {
                    AddUser(chatHub, id, name, userid);
                }

                // On User Disconnected
                chatHub.client.onUserDisconnected = function (id, userName) {
                    $('#' + id).remove();
                }

                chatHub.client.messageReceived = function (userName, message) {
                    AddMessage(userName, message);
                    //var code = "<p>" + message + "</p>";
                    //$("#chat_box").append(code);
                }


                chatHub.client.sendPrivateMessage = function (windowId, fromUserName, chatTitle, message) {
                    console.log("sendPrivateMessage" + windowId + "fromUserName :" + fromUserName + "msg:" + message);
                    var ctrId = 'private_' + windowId;
                    if ($('#' + ctrId).length == 0) {
                        console.log("if cond :")
                        createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, chatTitle);
                        $('#chatAudio')[0].play();
                    }
                    else {
                        var rType = CheckHiddenWindow();
                        if ($('#' + ctrId).parent().css('display') == "none") {
                            $('#' + ctrId).parent().parent().effect("shake", { times: 2 }, 1000);
                            rType = true;
                        }
                        if (rType == true) {
                            $('#chatAudio')[0].play();
                        }
                    }

                    // To Be changed - Ravi
                    //$('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                    //
                    $('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                    $('#typing_' + windowId).hide();
                }
                // Ravi

                chatHub.client.sendGroupMessage = function (chatTitle, windowId, message, fromUserName) {
                    //console.log("windowID" + windowId);
                    //console.log("fromUsername" + fromUserName);
                    //console.log("ChatTitle: " + chatTitle);
                    console.log("mesasge: " + message);
                    var ctrId = "group_" + windowId;
                    //console.log("ctrID---------", $('#' + ctrId).length );
                    if ($('#' + ctrId).length == 0) {
                        //console.log("I am here");
                        createPrivateChatWindow(chatHub, windowId, ctrId, fromUserName, chatTitle);
                        $('#chatAudio')[0].play();
                    }
                    else {
                        var rType = CheckHiddenWindow();
                        if ($('#' + ctrId).parent().css('display') == "none") {
                            $('#' + ctrId).parent().parent().effect("shake", { times: 2 }, 1000);
                            rType = true;
                        }
                        if (rType == true) {
                            $('#chatAudio')[0].play();
                        }
                    }

                    // To Be changed - Ravi
                    //$('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                    //
                    $('#' + ctrId).chatbox("option", "boxManager").addMsg(fromUserName, message);
                    $('#typing_' + windowId).hide();
                }


                // Testing



                chatHub.client.receiveMessage = function (msgFrom, msg, senderid) {

                    if (msgFrom == "NewConnection") {
                        ////console.log("msg:", msg);
                        $("#usersCount").text(senderid);
                        $('#divUsers').append('<li>' + msg + '</li>')
                    }
                    else if (msgFrom == "ChatHub") {
                        ////console.log("msg:", msg);
                        $("#usersCount").text(senderid);
                        $("#connID").text(msg);
                    }
                    else if (msgFrom == "RU") {
                        ////console.log("msg:", msg);
                        var online = senderid.split('#');
                        var length = online.length;
                        for (var i = 0; i < length; i++) {
                            $('#divUsers').append('<li>' + online[i] + '</li>')
                        }

                        $('#divChat').append('<li><strong>' + msgFrom
                            + '</strong>:&nbsp;&nbsp;' + msg + '</li>')
                    }
                    else {
                        ////console.log("msg:", msg);
                        $("#txtTo").val(senderid);
                        $('#divChat').append('<li><strong>' + msgFrom
                            + '</strong>:&nbsp;&nbsp;' + msg + '</li>')
                    }
                };

                chatHub.client.GetLastMessages = function (TouserID, CurrentChatMessages) {
                    //debugger;
                    var ctrId = 'private_' + TouserID;

                    var AllmsgHtml = "";
                    for (i = 0; i < CurrentChatMessages.length; i++) {
                        if (CurrentChatMessages[i].Message.includes("#")) {
                            var array = CurrentChatMessages[i].Message.split("#");
                            var fileName = array[1].split('\\');
                            var msg = '<a href="' + array[1] + '">' + fileName[fileName.length - 1] + '</a>';
                            CurrentChatMessages[i].Message = msg;


                        }

                        AllmsgHtml += "<div id='divChatWindow' style=\"display: block; max-width: 200px;\" class=\"ui-chatbox-msg\">";
                        if (i == CurrentChatMessages.length - 1) {
                            if ($('#' + ctrId).children().last().html() != "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>") {
                                AllmsgHtml += "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>";
                            }
                        }
                        else {
                            AllmsgHtml += "<b>" + CurrentChatMessages[i].FromUserName + ": </b><span>" + CurrentChatMessages[i].Message + "</span>";
                        }
                        AllmsgHtml += "</div>";
                    }
                    $('#' + ctrId).prepend(AllmsgHtml);


                }


                chatHub.client.GetGroupLastMessages = function (TouserID, CurrentChatMessages) {
                    //debugger;
                    var TouserID = TouserID;
                    //console.log("TouserID: " + TouserID);
                    if (TouserID.includes("group_")) {
                        //console.log("in Get Messages - group");
                        var ctrId = TouserID;
                        ////console.log('Helo' + CurrentChatMessages[0].txt)
                        var AllmsgHtml = "";
                        for (i = 0; i < CurrentChatMessages.length; i++) {
                            if (CurrentChatMessages[i].txt.includes("#")) {
                                var array = CurrentChatMessages[i].txt.split("#");
                                var fileName = array[1].split('\\');
                                var msg = '<a href="' + array[1] + '">' + fileName[fileName.length - 1] + '</a>';
                                CurrentChatMessages[i].txt = msg;


                            }

                            AllmsgHtml += "<div id='divChatWindow' style=\"display: block; max-width: 200px;\" class=\"ui-chatbox-msg\">";
                            if (i == CurrentChatMessages.length - 1) {
                                if ($('#' + ctrId).children().last().html() != "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>") {
                                    AllmsgHtml += "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>";
                                }
                            }
                            else {
                                AllmsgHtml += "<b>" + CurrentChatMessages[i].sender + ": </b><span>" + CurrentChatMessages[i].txt + "</span>";
                            }
                            AllmsgHtml += "</div>";
                        }
                        $('#' + ctrId).prepend(AllmsgHtml);
                    }

                }
                chatHub.client.sampleMessage = function (toUser, fromUser, fromUserid, groupid, groupName, msg) {
                    ////console.log(" groupName" + groupName + "groupid" + groupid);
                    var sel = document.getElementById('join_groups');
                    var opt = document.createElement('option');
                    opt.appendChild(document.createTextNode(groupName));
                    opt.value = groupName;
                    sel.appendChild(opt);
                    var connectionid = $('#hdId').val();
                    code = $('<div id="' + groupName + '" class="col-sm-12 bg-success"  ><i class=\"fa fa-user\"></i> ' + groupName + '<div>');
                    $("#chat_box").append(code);
                    $(".mydiv").append(code);
                    var id = groupid;
                    //OpenPrivateChatWindow(chatHub, id, groupName);
                    ////console.log(" hdUsername--------------------" + $('#hdUserName').val());
                    //chatHub.server.broadCastMessage($('#hdUserName').val(), msg, groupName);
                    $(code).dblclick(function () {
                        var id = $(this).attr('id');
                        ////console.log("samplemessghae:", id)
                        if (connectionid != id) {
                            ////console.log("groupid ---id"+id)
                            OpenPrivateChatWindow(chatHub, "group_" + id, groupName);
                        }
                    });
                }
                chatHub.client.ReceiveTypingRequest = function (userId) {
                    var ctrId = 'private_' + userId;
                    if ($('#' + ctrId).length > 0) {
                        jQuery('#typing_' + userId).show();
                        jQuery('#typing_' + userId).delay(6000).fadeOut("slow");
                    }
                }

            });
            // This optional function html-encodes messages for display in the page.
            function htmlEncode(value) {
                var encodedValue = $('<div />').text(value).html();
                return encodedValue;
            }


            function registerEvents(chatHub) {
                var UserName = $("[id$=hdnCurrentUserName]").val();
                console.log("Username:", UserName);
                var UserID = parseInt($("[id$=hdnCurrentUserID]").val());
                console.log("Username:", UserID);
                chatHub.server.connect(UserName, UserID);

                //chatProxy.server.connect($("#spnName").text(), $("#connID").text(), $("#connID").text());
            }



            function registerClientMethods(chatHub) {
                // Calls when user successfully logged in
                chatHub.client.onConnected = function (id, userName, allUsers, messages, userid) {
                    $('#hdId').val(id);

                    $('#hdUserName').val(userName);

                    // Add All Users
                    for (i = 0; i < allUsers.length; i++) {
                        //AddUser(chatHub, allUsers[i].ConnectionId, allUsers[i].UserName, userid);
                        console.log("Adding User:" + allUsers[i].UserName)
                        AddUser(chatHub, allUsers[i].UserID, allUsers[i].UserName, userid);
                    }

                    // Add Existing Messages
                    for (i = 0; i < messages.length; i++) {
                        AddMessage(messages[i].UserName, messages[i].Message);
                    }

                }
            }





            function sendtoGroup(groupName) {
                chatHub.server.broadCastMessage($("#spnName").text(), $("#txtMsg").val(), groupName);
                $('#txtMsg').val('').focus();
            }
            function CheckHiddenWindow() {
                var hidden, state;

                if (typeof document.hidden !== "undefined") {
                    state = "visibilityState";
                } else if (typeof document.mozHidden !== "undefined") {
                    state = "mozVisibilityState";
                } else if (typeof document.msHidden !== "undefined") {
                    state = "msVisibilityState";
                } else if (typeof document.webkitHidden !== "undefined") {
                    state = "webkitVisibilityState";
                }

                if (document[state] == "hidden")
                    return true;
                else
                    return false;

            }

            function AddUser(chatHub, id, name, userid) {
                var currentuserid = parseInt($("[id$=hdnCurrentUserID]").val());
                console.log("currentuserid:" + currentuserid);
                var connectionid = $('#hdId').val();
                console.log("connectionid:" + connectionid);
                var code = "";
                if (connectionid == "") {
                    if (userid == currentuserid) {
                        $('#hdId').val(id);
                        connectionid = id;
                        $('#hdUserName').val(name);
                    }
                }
                if (connectionid != id) {
                    if ($('#' + id).length == 0) {
                        code = $('<a id="' + id + '" class="col-sm-12 bg-success" > <i class=\"fa fa-user\"></i> ' + name + '<a>');
                        $(code).dblclick(function () {
                            var id = $(this).attr('id');
                            if (connectionid != id) {
                                OpenPrivateChatWindow(chatHub, id, name);
                            }
                        });
                    }
                }
                else {
                    if ($('#curruser_' + id).length == 0) {
                        code = $('<div id="curruser_' + id + '" class="col-sm-12 bg-info"  ><i class=\"fa fa-user\"></i> ' + name + '<div>');

                    }
                }

                //file_image = $('<div><button type="button">Click Me!</button><div>');
                $("#chat_box").append(code);


                //$("#chat_box").append(file_image);
            }


            function AddUsertoGroup(chatHub, id, name, userid) {
                var currentuserid = parseInt($("[id$=hdnCurrentUserID]").val());
                ////console.log("currentuserid:" + currentuserid);
                var connectionid = $('#hdId').val();
                ////console.log("connectionid:" + connectionid);
                var code = "";
                if (connectionid == "") {
                    if (userid == currentuserid) {
                        $('#hdId').val(id);
                        connectionid = id;
                        $('#hdUserName').val(name);
                    }
                }


                if (connectionid != id) {
                    if ($('#' + id).length == 0) {
                        code = $('<a id="' + id + '" class="col-sm-12 bg-success" > <i class=\"fa fa-user\"></i> ' + name + '<a>');
                        $(code).dblclick(function () {
                            var id = $(this).attr('id');
                            if (connectionid != id) {
                                OpenPrivateChatWindow(chatHub, id, name);
                            }
                        });
                    }
                }
                else {
                    if ($('#curruser_' + id).length == 0) {
                        code = $('<div id="curruser_' + id + '" class="col-sm-12 bg-info"  ><i class=\"fa fa-user\"></i> ' + name + '<div>');

                    }
                }

                //file_image = $('<div><button type="button">Click Me!</button><div>');
                $("#chat_box").append(code);
                //$("#chat_box").append("<button id='btnSend' onclick='sendtoGroup()' >Send Message</button>");
                //$("#chat_box").append(file_image);
            }

            //function OpenPrivateChatWindow(chatHub, id, userName) {
            //    var ctrId = 'private_' + id;
            //    if ($('#' + ctrId).length > 0) return;
            //    createPrivateChatWindow(chatHub, id, ctrId, userName, userName);
            //}
            function OpenPrivateChatWindow(chatHub, id, userName) {
                var ctrId = "";
                //console.log("Username: " + userName + "  ID:"+ id)
                if (id.includes("group_")) {
                    ctrId = id
                    //////console.log("crtd group_:" + ctrId);
                } else {
                    ctrId = 'private_' + id;
                }

                if ($('#' + ctrId).length > 0) return;

                createPrivateChatWindow(chatHub, id, ctrId, userName, userName);

            }

            function createPrivateChatWindow(chatHub, userId, ctrId, userName, chatTitle) {
                console.log("create PrivateChat Window ctrId:" + ctrId);
                var srp = "@Url.Content("~")";
                $("#chat_div").append("<div id=\"" + ctrId + "\"></div>")
                showList.push(ctrId);

                $('#' + ctrId).chatbox({
                    id: ctrId,
                    title: chatTitle,
                    user: userName,
                    offset: getNextOffset(),
                    width: 200,
                    messageSent: function (id, user, msg) {
                        if (id.includes("group_")) {
                            var group_name = id.split("_");
                            chatHub.server.broadCastMessage($('#hdUserName').val(), msg, group_name[1])
                        } else {
                            chatHub.server.sendPrivateMessage(userId, msg);
                        }


                        //chatHub.server.sendmessagetoall(userId, msg);
                        TypingFlag = true;
                    },
                    boxClosed: function (removeid) {
                        $('#' + removeid).remove();
                        var idx = showList.indexOf(removeid);
                        if (idx != -1) {
                            showList.splice(idx, 1);
                            diff = config.width + config.gap;
                            for (var i = idx; i < showList.length; i++) {
                                offset = $("#" + showList[i]).chatbox("option", "offset");
                                $("#" + showList[i]).chatbox("option", "offset", offset - diff);
                            }
                        }
                    }

                });

                $('#' + ctrId).siblings().css("position", "relative");
                $('#' + ctrId).siblings().append("<div id=\"typing_" + userId + "\" style=\"width:20px; height:20px; display:none; position:absolute; right:14px; top:8px\"><img height=\"20\" src=\"" + srp + "images/pencil.gif\" /></div>");
                $('#' + ctrId).siblings().append("<input type='file' id='fileUpload_" + userId + "' /> ");
                console.log("Sending UserId", userId);
                $('#' + ctrId).siblings().append("<input type='button' id='btnUploadFile' value='Send' onclick='onUploadButton(" + userId + "," + ctrId + ")'/>");
                $('#' + ctrId).siblings().find('textarea').on('input', function (e) {
                    if (TypingFlag == true) {
                        chatHub.server.sendUserTypingRequest(userId);
                    }
                    TypingFlag = false;
                });

                var FromUserID = parseInt($("[id$=hdnCurrentUserID]").val());
                var ToUserID = userId;
                //console.log("For Last Messages:", ToUserID);
                if (ToUserID.includes("group_")) {
                    //console.log("Calling  RequestLastGroupMessage");
                    //var group_name = ToUserID.split("_");
                    chatHub.server.RequestLastGroupMessage(FromUserID, ToUserID);
                } else {
                    chatHub.server.requestLastMessage(FromUserID, ToUserID);
                }

            }



            // list of boxes shown on the page
            var showList = new Array();
            var config = {
                width: 200, //px
                gap: 20,
                maxBoxes: 5
            };

            var getNextOffset = function () {
                return (config.width + config.gap) * showList.length;
            };

            var TypingFlag = true;

            function ResetTypingFlag() {
                TypingFlag = true;
            }

            function AddMessage(userName, message) {
                //////console.log("Called Addmesssge from group");
                //$('#divChatWindow').append('<div class="message"><span class="userName">' + userName + '</span>: ' + message + '</div>');
                //var height = $('#divChatWindow')[0].scrollHeight;
                //$('#divChatWindow').scrollTop(height);
            }

            function saveFile() {
                ////console.log("Clicked on save file");
                var firstName = $("#fileContainer").val();
                ////console.log(firstName.files[0])
                localStorage.setItem("file", firstName)
            }

            function showfileName(userId, ctrId) {
                var x = document.getElementById('fileContainer');
                ////console.log(x.files.length);
                if (x.files.length > 0) {
                    ////console.log("Inside length");
                    getBase64(x.files[0], userId);

                }


            }

            function onUploadButton(userId, ctrId) {
                console.log("onUpload Button:", userId);
                var data = new FormData();
                var filename_v;
                if (typeof userId.id === 'undefined') {
                    //flag = false;
                    var files = $("#fileUpload_" + userId).get(0).files;
                } else {
                    if (userId.id.includes("group_")) {
                        //flag = true
                        var files = $("#fileUpload_" + userId.id).get(0).files;
                    }
                }
                //var files = $("#fileUpload_" + userId).get(0).files;
                //$("#fileUpload").value = "";
                //$("#fileUpload").val('');



                // Add the uploaded image content to the form data collection
                console.log("Length of files", files.length)
                if (files.length > 0) {
                    data.append("UploadedImage", files[0]);
                    filename_v = files[0].filename;
                    console.log(files[0])
                }

                var flag = false;

                if (typeof userId.id === 'undefined') {
                    flag = false;
                } else {
                    if (userId.id.includes("group_")) {
                        flag = true
                    }
                }


                // Make Ajax request with the contentType = false, and procesDate = false
                if (flag) {
                    var group_name = userId.id.split("_");
                    var ajaxRequest = $.ajax({
                        type: "POST",
                        url: "/api/fileupload/uploadfile",
                        contentType: false,
                        processData: false,
                        data: data
                    });
                    ajaxRequest.done(function (xhr, textStatus) {
                        var f_tag = "#" + xhr.Value;
                        console.log("xhr.Value", f_tag)
                        chatHub.server.broadCastMessage($('#hdUserName').val(), f_tag, group_name[1]);
                    });
                    //$("#fileUpload").val('');
                } else {
                    var ajaxRequest = $.ajax({
                        type: "POST",
                        url: "/api/fileupload/uploadfile",
                        contentType: false,
                        processData: false,
                        data: data
                    });

                    ajaxRequest.done(function (xhr, textStatus) {
                        var f_tag = "#" + xhr.Value;
                        chatHub.server.sendPrivateMessage(userId, f_tag);

                    });
                    //$("#fileUpload").val('');
                }
                //
                //files = '';
            }

            function btnUpload() {
                ////console.log("Helloword")
                // Checking whether FormData is available in browser
                if (window.FormData !== undefined) {
                    ////console.log("Inside Ajax function")
                    var fileUpload = document.getElementById("FileUpload1").get(0);
                    var files = fileUpload.files;

                    // Create FormData object
                    var fileData = new FormData();

                    // Looping over all files and add it to FormData object
                    for (var i = 0; i < files.length; i++) {
                        fileData.append(files[i].name, files[i]);
                        //////console.log(files[i]);
                    }

                    // Adding one more key to FormData object
                    fileData.append('username', 'Manas');

                    $.ajax({
                        type: "POST",
                        url: 'StartChat.aspx/UploadFiles',
                        contentType: false, // Not to set any content header
                        processData: false, // Not to process data
                        data: fileData,
                        dataType: "json",
                        success: function (result) {
                            alert(result.d);

                        },
                        error: function (err) {
                            alert(err.statusText);
                        }
                    });
                } else {
                    alert("FormData is not supported.");
                }
            }


        </script>*@

}